name: "Release"
on:
  release:
    types: [ published ]
permissions:
  contents: write
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GRAILS_PUBLISH_RELEASE: 'true'
  JAVA_DISTRIBUTION: liberica
  JAVA_VERSION: 17.0.18 # this must be a specific version for reproducible builds, keep it sync with .sdkmanrc
  NEXUS_PUBLISH_URL: https://ossrh-staging-api.central.sonatype.com/service/local/
  REPO_NAME: ${{ github.event.repository.name }}
  TAG: ${{ github.event.release.tag_name }}
  VERSION: will be computed in each job
jobs:
  publish:
    name: "Publish to Sonatype Staging Repository"
    runs-on: ubuntu-24.04
    steps:
      - name: "üìù Establish release version"
        run: |
          echo "Release version: ${TAG#v}"
          echo "VERSION=${TAG#v}" >> "$GITHUB_ENV"
      - name: "üì• Checkout the repository"
        uses: actions/checkout@v6
        with:
          ref: ${{ env.TAG }}
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: "üìÖ Store common build date" # to ensure a reproducible build
        run: echo "SOURCE_DATE_EPOCH=$(git log -1 --pretty=%ct)" >> "$GITHUB_ENV"
      - name: "üìÖ Ensure source files use common date"
        run: find . -depth \( -type f -o -type d \) -exec touch -d "@${SOURCE_DATE_EPOCH}" {} +
      - name: "‚òïÔ∏è Setup JDK"
        uses: actions/setup-java@v5
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
      - name: "üêò Setup Gradle"
        uses: gradle/actions/setup-gradle@v5
        with:
          build-scan-publish: true
          build-scan-terms-of-use-url: https://gradle.com/terms-of-service
          build-scan-terms-of-use-agree: yes
      - name: "‚öôÔ∏è Run pre-release"
        uses: apache/grails-github-actions/pre-release@asf
        env:
          RELEASE_VERSION: ${{ env.VERSION }}
      - name: "üîê Generate key file for artifact signing"
        run: printf "%s" "$SECRING_FILE" | base64 -d > "${{ github.workspace }}/secring.gpg"
        env:
          SECRING_FILE: ${{ secrets.SECRING_FILE }}
      - name: "üì§ Publish to Staging Repository"
        env:
          NEXUS_PUBLISH_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          NEXUS_PUBLISH_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          NEXUS_PUBLISH_DESCRIPTION: '${{ env.REPO_NAME }}:${{ env.VERSION }}'
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSPHRASE: ${{ secrets.SIGNING_PASSPHRASE }}
        run: >
          ./gradlew
          -Psigning.keyId=${SIGNING_KEY}
          -Psigning.secretKeyRingFile=${{ github.workspace }}/secring.gpg
          publishMavenPublicationToSonatypeRepository
          closeSonatypeStagingRepository
      - name: "üìÖ Generate Build Date file"
        run: |
          mkdir -p build
          echo "$SOURCE_DATE_EPOCH" >> build/BUILD_DATE.txt
      - name: "üì§ Upload Build Date file"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: build/BUILD_DATE.txt
  release:
    name: "Release Artifacts and Run Post-Release"
    needs: publish
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: "üìù Establish release version"
        run: |
          echo "Release version: ${TAG#v}"
          echo "VERSION=${TAG#v}" >> "$GITHUB_ENV"
      - name: "üì• Checkout repository"
        uses: actions/checkout@v6
        with:
          ref: ${{ env.TAG }}
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: "‚òïÔ∏è Setup JDK"
        uses: actions/setup-java@v5
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
      - name: "üêò Setup Gradle"
        uses: gradle/actions/setup-gradle@v5
        with:
          build-scan-publish: true
          build-scan-terms-of-use-url: https://gradle.com/terms-of-service
          build-scan-terms-of-use-agree: yes
      - name: "üì§ Release to Maven Central"
        env:
          NEXUS_PUBLISH_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          NEXUS_PUBLISH_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          NEXUS_PUBLISH_DESCRIPTION: '${{ env.REPO_NAME }}:${{ env.VERSION }}'
        run: >
          ./gradlew
          findSonatypeStagingRepository
          releaseSonatypeStagingRepository
      - name: "‚öôÔ∏è Run post-release"
        uses: apache/grails-github-actions/post-release@asf
